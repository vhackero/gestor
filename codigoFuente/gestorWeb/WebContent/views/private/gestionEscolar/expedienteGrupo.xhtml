<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<ui:composition template="/templates/layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:sec="http://www.springframework.org/security/tags">
	<ui:define name="breadcrumb">
		<li>#{sistema.obtenerTexto('gw.gestionescolar.label.gestionEscolar')}</li>
		<li>Expediente de estudiantes por grupo</li>
	</ui:define>
	<ui:define name="content">
		<h:form>
			<p:ajaxStatus onstart="PF('dialogLayout').show()"
				onsuccess="PF('dialogLayout').hide()" />
			<h1>Expediente de estudiantes por grupo</h1>
			<hr />
			<f:validateBean disabled="true">
				<p:panel header="Búsqueda de grupo">
					<!--Estructura Nueva-->
					<div class="form-group">
						<div class="row">
							<div class="col-md-4 col-xs-12">
								<p:outputLabel styleClass="requerido" value="Plan:"/>
								<p:selectOneMenu id="nvoCatPlan" styleClass="col-xs-12"
												 value="#{expedienteEventoBean.idPlan}"
												 valueChangeListener="#{expedienteEventoBean.onChangeCatPlan}">
									<p:ajax update="@form"/>
									<f:selectItem
											itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
											itemValue="#{0}"/>
									<f:selectItems value="#{expedienteEventoBean.nodos}"
												   var="plan" itemLabel="#{plan.nombre}" itemValue="#{plan.idNodo}"/>
								</p:selectOneMenu>
								<p:message for="nvoCatPlan"/>
							</div>

							<p:outputPanel id="pnlEstructuras">
								<p:outputPanel
										rendered="#{not empty expedienteEventoBean.catEstructuras}">
									<div class="col-md-4 col-xs-12">
										<p:outputLabel styleClass="requerido" value="Estructura:"/>
										<p:selectOneMenu id="nvoCatEstruc" styleClass="col-xs-12"
														 valueChangeListener="#{expedienteEventoBean.onChangeCatEstructura}">
											<p:ajax update="@form"/>
											<f:selectItem
													itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
													itemValue="#{0}"/>
											<f:selectItems
													value="#{expedienteEventoBean.catEstructuras}"
													var="estruc" itemLabel="#{estruc.nombre}"
													itemValue="#{estruc.id}"/>
										</p:selectOneMenu>
										<p:message for="nvoCatEstruc"/>
									</div>
								</p:outputPanel>
							</p:outputPanel>

							<p:outputPanel id="pnlSubestructuras1">
								<p:outputPanel
										rendered="#{not empty expedienteEventoBean.catSubEstructurasNivel1}">
									<div class="col-md-4 col-xs-12">
										<p:outputLabel styleClass="requerido" value="Subestructura 1:"/>
										<p:selectOneMenu id="nvoCatSubEstruc1" styleClass="col-xs-12"
														 valueChangeListener="#{expedienteEventoBean.onChangeCatSubestructura1}">
											<p:ajax update="@form"/>
											<f:selectItem
													itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
													itemValue="#{0}"/>
											<f:selectItems
													value="#{expedienteEventoBean.catSubEstructurasNivel1}"
													var="subEstruc1" itemLabel="#{subEstruc1.nombre}"
													itemValue="#{subEstruc1.id}"/>
										</p:selectOneMenu>
										<p:message for="nvoCatSubEstruc1"/>
									</div>
								</p:outputPanel>
							</p:outputPanel>

						</div>
					</div>

					<div class="form-group" hidden="true">
						<div class="row">
							<div class="col-md-6">
								<p:outputLabel styleClass="bloque" value="Tipo de competencia:" />
								<p:selectOneMenu id="tipoCompetencia"
												 disabled="true"
									value="#{expedienteEventoBean.filtroPrograma.tipoCompetencia}"
									autoWidth="true" styleClass="col-xs-12"
									valueChangeListener="#{expedienteEventoBean.onChangeTipoCompetencia}">
									<p:ajax event="change" process="@this" update="@form" />
									<f:selectItem
										itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
										itemValue="#{0}" />
									<f:selectItems value="#{expedienteEventoBean.catalogoTipoComp}"
										var="tipoComp" itemLabel="#{tipoComp.nombre}"
										itemValue="#{tipoComp.id}" />
								</p:selectOneMenu>
							</div>
							<div class="col-md-6">
								<p:outputLabel styleClass="bloque" value="Eje de capacitación:" />
								<p:selectOneMenu id="ejeCapacitacion"
									value="#{expedienteEventoBean.filtroPrograma.ejeCapacitacion}"
									disabled="true"
									styleClass="col-xs-12" autoWidth="true"
									valueChangeListener="#{expedienteEventoBean.onChangeEjeCapacitacion}">
									<p:ajax event="change" process="@this" update="@form" />
									<f:selectItem
										itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
										itemValue="#{0}" />
									<f:selectItems value="#{expedienteEventoBean.catalogoEjeCap}"
										var="ejeCap" itemLabel="#{ejeCap.nombre}"
										itemValue="#{ejeCap.id}" />
								</p:selectOneMenu>

							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="row">
							<div class="col-md-6">
								<p:outputLabel styleClass="bloque" value="Nombre del programa:" />
								<p:selectOneMenu id="programa"
									disabled="#{empty expedienteEventoBean.listaProgramas}"
									value="#{expedienteEventoBean.idPrograma}"
									styleClass="col-xs-12">
									<p:ajax listener="#{expedienteEventoBean.onProgramaChange()}"
										update="@form" />
									<f:selectItem
										itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
										itemValue="#{0}" />
									<f:selectItems value="#{expedienteEventoBean.listaProgramas}"
										var="programa" itemLabel="#{programa.nombreTentativo}"
										itemValue="#{programa.idPrograma}" />
								</p:selectOneMenu>
							</div>
							<div class="col-md-6">
								<p:outputLabel styleClass="bloque" value="Nombre del evento:" />
								<p:selectOneMenu id="evento"
									disabled="#{expedienteEventoBean.idPrograma eq 0}"
									value="#{expedienteEventoBean.idEvento}" styleClass="col-xs-12">
									<p:ajax listener="#{expedienteEventoBean.onEventoChange()}"
										update="@form" />
									<f:selectItem
										itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
										itemValue="#{0}" />
									<f:selectItems value="#{expedienteEventoBean.listaEventos}"
										var="evento" itemLabel="#{evento.nombreEc}"
										itemValue="#{evento.idEvento}" />
								</p:selectOneMenu>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<p:outputLabel styleClass="bloque" value="Grupo:" />
							<p:selectOneMenu id="grupo" autoWidth="true"
								disabled="#{expedienteEventoBean.idEvento eq 0}"
								value="#{expedienteEventoBean.idGrupo}" styleClass="col-xs-12">
								<p:ajax process="@this" update="@form" />
								<f:selectItem
									itemLabel="#{sistema.obtenerTexto('gw.textos.menu.seleccionar')}"
									itemValue="#{0}" />
								<f:selectItems value="#{expedienteEventoBean.listaGrupos}"
									var="grupo" itemLabel="#{grupo.nombre}"
									itemValue="#{grupo.idGrupo}" />
							</p:selectOneMenu>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12 text-right">
							<p:commandButton value="Limpiar campos" ajax="true"
								styleClass="btn btn-default"
								action="#{expedienteEventoBean.limpiarFiltro()}" update="@form" />
							<p:commandButton id="btnBuscar" value="Buscar"
								disabled="#{expedienteEventoBean.idGrupo eq 0}"
								action="#{expedienteEventoBean.buscarAlumnosAprobados()}"
								ajax="true" update="@form" styleClass="btn btn-primary" />
						</div>
					</div>
				</p:panel>

				<p:panel id="panelResultados" header="Resultado de la búsqueda">
					<p:dataTable id="tablaResultados" reflow="true"
						value="#{expedienteEventoBean.alumnosConConstancia}" var="alumno"
						paginator="true" rows="10" paginatorPosition="bottom"
						emptyMessage="#{sistema.obtenerTexto('gw.textos.tablas.sinRegistros')}"
						paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
						currentPageReportTemplate="({currentPage} de {totalPages})"
						rowsPerPageTemplate="5,10,15" tableStyleClass="table">
						<p:column headerText="No." styleClass="text-center">
							<h:outputText value="#{alumno.persona.idPersona}" />
						</p:column>
						<p:column headerText="Matricula"
							styleClass="text-center">
							<h:outputText value="#{alumno.persona.usuario}" />
						</p:column>
						<p:column headerText="Nombre del estudiante "
							styleClass="text-center">
							<h:outputText value="#{alumno.persona.nombreCompleto}" />
						</p:column>
						<p:column headerText="Calificación final" styleClass="text-center">
							<h:outputText value="#{alumno.califFinal}" />
						</p:column>
<!-- 						<p:column headerText="Constancias" styleClass="text-center"> -->
<!-- 							<p:commandButton id="btnVerConstancia" process="@this" -->
<!-- 								actionListener="#{expedienteEventoBean.verConstancia(alumno)}" -->
<!-- 								ajax="true" -->
<!-- 								styleClass="btn-icon btn btn-default icono_sisi fa fa-solid fa-eye"> -->
<!-- 							</p:commandButton> -->
<!-- 							<p:tooltip for="btnVerConstancia" position="top" value="Ver" /> -->
<!-- 							<p:commandButton id="btnDescargarConstancia" process="@this" -->
<!-- 								onclick="PrimeFaces.monitorDownload(start, stop);" -->
<!-- 								actionListener="#{expedienteEventoBean.descargarConstancia(alumno)}" -->
<!-- 								ajax="false" -->
<!-- 								styleClass="btn-icon btn btn-default icono_sisi fa fa-regular fa-circle-down text-align: center;"> -->
<!-- 								<p:fileDownload value="#{expedienteEventoBean.constanciaPDF}" /> -->
<!-- 							</p:commandButton> -->
<!-- 							<p:tooltip for="btnDescargarConstancia" position="top" -->
<!-- 								value="Descargar" /> -->
<!-- 						</p:column> -->

					</p:dataTable>
					<br/>


					<!-- Tabla oculta para exportación -->
					<p:dataTable id="exportTable"
						value="#{expedienteEventoBean.alumnosConConstancia}"
						var="partCalif" rendered="false" style="display:none;">
						<!-- Aquí "tablaAuxCalif" sería tu lista de datos sin elementos editables -->

						<!-- Columnas para la tabla oculta -->
						<p:column>
							<f:facet name="header">
								<h:outputText value="No." />
							</f:facet>
							<h:outputText value="#{partCalif.persona.idPersona}" />
						</p:column>

						<p:column>
							<f:facet name="header">
								<h:outputText value="Matricula" />
							</f:facet>
							<h:outputText value="#{partCalif.persona.usuario}" />
						</p:column>

						<p:column>
							<f:facet name="header">
								<h:outputText value="Nombre del estudiante " />
							</f:facet>
							<h:outputText value="#{partCalif.persona.nombreCompleto}" />
						</p:column>

						<p:column>
							<f:facet name="header">
								<h:outputText value="Calificación final" />
							</f:facet>
							<h:outputText value="#{partCalif.califFinal}" />
						</p:column>

						
						
					</p:dataTable>

					<br/>


					<div class="row">
						<div class="col-md-12 text-right">

							<p:outputLabel value="Descargar Calificaciones: " rendered="true"
								styleClass="margenIzquierdo agregaHeight" />
							<p:commandButton id="btnActaCalificaciones" ajax="true" 
								rendered="true"
								styleClass="btn btn-icon btn-default icono_sisi ss_gn_desc"
								action="#{expedienteEventoBean.descargarPlantillaCalificaciones}" />

							<p:outputLabel value="Exportar XLS: "
								styleClass="margenIzquierdo agregaHeight" />
							<p:commandButton id="btnDescargar" ajax="false"
								disabled="#{expedienteEventoBean.alumnosConConstancia.isEmpty()}"
								styleClass="btn btn-default btn-icon icono_sisi ss_adm_desexcel">
								<p:dataExporter type="xls" target="exportTable"
									fileName="#{expedienteEventoBean.eventoNombre}" encoding="UTF-8" />
							</p:commandButton>

							
							<!-- <p:outputLabel value="Descargar PDF: " rendered="true"
							styleClass="margenIzquierdo agregaHeight" />
							<p:commandButton id="btnDescargarPdf" ajax="false"
								rendered="true"
								disabled="#{expedienteEventoBean.alumnosConConstancia.isEmpty()}"
								styleClass="btn btn-icon btn-default icono_sisi ss_gn_desc">
								<p:dataExporter type="pdf" target="exportTable"
									fileName="#{expedienteEventoBean.grup}" encoding="ISO-8859-15"/>
							</p:commandButton> -->

						</div>
					</div>
					<br/>






					<div class="row flexY">
						<div class="col-md-12 text-right" hidden="true">
							<p:outputLabel value="Constancias: " />
							<p:commandButton id="btnDescargarTodasLasConstancia"
								value="Descargar" process="@this"
								onclick="PrimeFaces.monitorDownload(start, stop);"
								disabled="#{empty expedienteEventoBean.alumnosConConstancia}"
								actionListener="#{expedienteEventoBean.descargarTodasLasConstancias}"
								ajax="false" styleClass="btn btn-primary">
								<p:fileDownload value="#{expedienteEventoBean.constanciasZip}" />
							</p:commandButton>
						</div>
					</div>

				</p:panel>
			</f:validateBean>
		</h:form>
		<p:dialog id="constancia" dynamic="true" responsive="true"
			modal="true" closable="false" resizable="false" position="center"
			header="Constancia" width="900" widgetVar="modalConstancia">

			<div class="form-group">
				<div class="row">
					<div class="col-md-12">
						<p:media player="pdf"
							value="#{expedienteEventoBean.constanciaPDF}" width="865"
							height="400" styleClass="agregaBorde" />
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<p:commandButton value="Cerrar" process="@this"
						styleClass="btn btn-default pull-right"
						onclick="PF('modalConstancia').hide();" />
				</div>
			</div>
		</p:dialog>

		<script type="text/javascript">
			function start() {
				PF('dialogLayout').show();
			}

			function stop() {
				PF('dialogLayout').hide();
			}
		</script>

		<p:dialog id="visorPdf" dynamic="true" responsive="true" modal="true"
		closable="false" resizable="false" position="center"
		header="Calificaciones" width="900" widgetVar="visorPlantilla">
		<div class="form-group">
			<div class="row">
				<div class="col-md-12">
					<p:media player="pdf"
						value="#{expedienteEventoBean.plantillaPDF}" width="865"
						height="400" styleClass="agregaBorde">
						<f:param name="id" value="#{expedienteEventoBean.idFile}" />
					</p:media>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<p:commandButton
					value="#{sistema.obtenerTexto('gw.admin.plantillas.btn.cerrar')}"
					styleClass="btn btn-default pull-right"
					onclick="PF('visorPlantilla').hide();" />
			</div>
		</div>
		</p:dialog>

	</ui:define>
</ui:composition>
